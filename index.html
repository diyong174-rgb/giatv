<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PeanutFlix</title>

  <!-- HLS.js (for .m3u8) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Shaka Player (for .mpd / DASH) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.min.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#fff}
    header{
      position:fixed;top:0;left:0;width:100%;z-index:1000;
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;background:rgba(0,0,0,.85)
    }
    .logo{color:#e50914;font-weight:700;font-size:20px}
    nav ul{list-style:none;display:flex;gap:14px}
    nav a{color:#fff;text-decoration:none;font-size:14px}
    nav a:hover{color:#e50914}

    .hero{
      height:60vh;display:flex;align-items:center;justify-content:center;
      padding-top:70px;
      background:linear-gradient(180deg,#0008,transparent),
        url('https://images.unsplash.com/photo-1517602302552-471fe67acf66?q=80&w=2070&auto=format&fit=crop') center/cover no-repeat
    }
    .hero h1{font-size:38px;text-shadow:0 2px 10px #000}

    .section{padding:85px 16px 28px;max-width:1100px;margin:0 auto}
    .hidden{display:none !important}

    /* IPTV video area */
    #video-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden}
    #video-player{width:100%;height:100%}
    .corner-btn{
      position:absolute;top:12px;padding:8px 12px;border:1px solid #fff6;
      background:rgba(0,0,0,.45);color:#fff;border-radius:8px;cursor:pointer;font-size:14px
    }
    #save-to-mylist-btn{ left:12px; z-index:999;} /* Adjusted */
    #open-drawer-btn{ right:12px; z-index:1000;} /* Adjusted */

    /* IPTV Drawer (right side) */
    #iptv-drawer{
      position:fixed;top:0;right:-320px;width:320px;height:100vh;z-index:1001;
      background:rgba(0,0,0,.75);backdrop-filter:blur(2px);
      border-left:1px solid #ffffff22;padding:78px 12px 16px;transition:right .28s ease-in-out
    }
    #iptv-drawer.open{right:0}
    #iptv-list{max-height:calc(100vh - 150px);overflow-y:auto;padding-right:4px}
    .ch-item{
      padding:10px;margin-bottom:8px;background:#222;border:1px solid #ffffff1a;
      border-radius:8px;cursor:pointer;transition:background .2s
    }
    .ch-item:hover{background:#2e2e2e}
    .ch-title{font-size:14px;font-weight:600}
    #iptv-search{
      width:100%;padding:8px;border-radius:8px;border:1px solid #ffffff22;
      background:#1a1a1a;color:#fff;margin-bottom:10px
    }

    /* Mobile layout - IPTV Drawer at the bottom */
    @media (max-width:900px){
      #iptv-sec {
        display: none; /* Hide IPTV section on mobile */
      }

      #iptv-drawer {
        bottom: 0; /* Position the drawer at the bottom of the screen on mobile */
        right: 0;  /* Ensure it's visible */
        top: auto; /* Remove top positioning */
        height: 40%; /* Adjust height for better mobile view */
      }

      #video-wrap {
        margin-bottom: 50px; /* Add space for the drawer button (which is visible on mobile) */
      }

      /* Remove the "Channels" button on mobile */
      #open-drawer-btn {
        display: none;
      }
    }

    /* Desktop layout - keep as is */
    @media (min-width:901px){
      #iptv-drawer {
        position: fixed;
        top: 0;
        right: -320px;
        width: 320px;
        height: 100vh;
        z-index: 1001;
        background: rgba(0, 0, 0, .75);
        backdrop-filter: blur(2px);
        border-left: 1px solid #ffffff22;
        padding: 78px 12px 16px;
        transition: right .28s ease-in-out;
      }
      #iptv-drawer.open {
        right: 0;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">PeanutFlix</div>
  <nav>
    <ul>
      <li><a href="#" onclick="showHome();return false;">Home</a></li>
      <li><a href="#" onclick="showIPTV();return false;">Live TV</a></li>
      <li><a href="#" onclick="showRadio();return false;">Radio</a></li>
      <li><a href="#" onclick="showMyList();return false;">MyList</a></li>
      <li><a href="#" onclick="showChat();return false;">Chatroom</a></li>
    </ul>
  </nav>
</header>

<!-- HOME / WELCOME -->
<section id="home-sec" class="hero">
  <h1>Welcome to PeanutFlix</h1>
</section>

<!-- IPTV ONLY -->
<section id="iptv-sec" class="section hidden">
  <h2 style="margin-bottom:12px;">Live TV</h2>
  <div id="video-wrap">
    <button id="save-to-mylist-btn" class="corner-btn">☆ Save</button>
    <button id="open-drawer-btn" class="corner-btn" onclick="openIPTVDdrawer()">Channels ▸</button>
    <div id="video-player"></div>
  </div>
  <p style="opacity:.7;margin-top:10px;font-size:12px;">Tip: The channel drawer is at the bottom of the screen on mobile.</p>
</section>

<!-- Radio Section -->
<section id="radio-sec" class="section hidden">
  <h2 style="margin-bottom:12px;">Radio</h2>
  <div id="radio-list"></div>
</section>

<!-- MyList Section -->
<section id="mylist-sec" class="section hidden">
  <h2 style="margin-bottom:12px;">MyList</h2>
  <div id="mylist-grid"></div>
</section>

<!-- Chatroom Section -->
<section id="chat-sec" class="section hidden">
  <h2 style="margin-bottom:12px;">Chatroom</h2>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input id="chat-text" type="text" placeholder="Type message..." onkeydown="if(event.key==='Enter'){sendMsg();}"/>
    <button class="btn" onclick="sendMsg()">Send</button>
  </div>
</section>

<!-- IPTV Drawer -->
<aside id="iptv-drawer">
  <h3 style="margin-bottom:10px;">IPTV Channels</h3>
  <input id="iptv-search" type="text" placeholder="Search channel...">
  <div id="iptv-list"></div>
</aside>

<script>
// Sample Channel Data
const CHANNELS = {
  IPTV: [
    { name: 'KAPAMILYA', url: 'https://cdn-ue1-prod.tsv2.amagi.tv/linear/amg01006-abs-cbn-kapcha-dash-abscbnono/index.mpd', type: 'mpd' },
    { name: '3RsTV', url: 'https://live20.bozztv.com/giatvplayout7/giatv-210631/tracks-v1a1/mono.ts.m3u8', type: 'hls' },
    { name: '3rsSinePinoy', url: 'https://live20.bozztv.com/giatvplayout7/giatv-210267/tracks-v1a1/mono.ts.m3u8', type: 'hls' },
    { name: 'STAR TELEVISION', url: 'https://live20.bozztv.com/giatvplayout7/giatv-210731/tracks-v1a1/mono.ts.m3u8', type: 'hls' },
  ],
  RADIO: [
    { name: '106.3 Yes FM Dagupan', url: 'https://yesfmdagupan.radioca.st/;', type: 'mp3', logo: 'https://i.ibb.co/yBqNhTZN/raryo.jpg' },
    { name: '98.3 Love Radio Dagupan', url: 'https://loveradiodagupan.radioca.st/;', type: 'mp3', logo: 'https://i.ibb.co/yBqNhTZN/raryo.jpg' }
  ]
};

let hls = null;
let shakaPlayer = null;
let drawerTimer = null;

// Function to play IPTV channels
async function playIPTV(channel) {
  destroyPlayers(); // stop video
  stopRadio();      // ensure radio off

  const wrap = document.getElementById('video-player');
  const video = document.createElement('video');
  video.setAttribute('playsinline', '');
  video.setAttribute('controls', '');
  video.style.width = '100%';
  video.style.height = '100%';
  wrap.appendChild(video);

  try {
    if (channel.type === 'hls' || /\.m3u8(\?|$)/i.test(channel.url)) {
      if (Hls.isSupported()) {
        hls = new Hls({ maxBufferLength: 30 });
        hls.on(Hls.Events.ERROR, (_, data) => console.warn('[HLS]', data));
        hls.loadSource(channel.url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = channel.url;
        await video.play().catch(() => {});
      } else {
        alert('HLS not supported.');
      }
      return;
    }

    if (channel.type === 'mpd' || /\.mpd(\?|$)/i.test(channel.url)) {
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        alert('Shaka: browser not supported.');
        return;
      }
      shakaPlayer = new shaka.Player(video);
      shakaPlayer.addEventListener('error', e => {
        const err = e.detail || e || {};
        console.error('[Shaka] error:', err);
      });

      await shakaPlayer.load(channel.url);
      await video.play().catch(() => {});
      return;
    }

    alert('Stream type not supported.');
  } catch (err) {
    console.error('[Player] fatal:', err);
    alert('Playback error. See console for details.');
  }
}

// Function to render IPTV channels in the drawer
function renderIPTVList(filter = '') {
  const list = document.getElementById('iptv-list');
  const q = (filter || '').toLowerCase();
  list.innerHTML = '';
  CHANNELS.IPTV
    .filter(ch => ch.name.toLowerCase().includes(q))
    .forEach(ch => {
      const item = document.createElement('div');
      item.className = 'ch-item';
      item.innerHTML = `<div class="ch-title">${ch.name}</div>`;
      item.onclick = () => { playIPTV(ch); restartDrawerAutoHide(); };
      list.appendChild(item);
    });
}

// Function to restart the drawer auto-hide timer
function restartDrawerAutoHide() {
  const d = document.getElementById('iptv-drawer');
  if (!d.classList.contains('open')) d.classList.add('open');
  if (drawerTimer) clearTimeout(drawerTimer);
  drawerTimer = setTimeout(() => { d.classList.remove('open'); }, 10000); // 10s
}

// Function to show Radio Section
function showRadio() {
  hideAll();
  document.getElementById('radio-sec').classList.remove('hidden');
  renderRadioList();
}

// Render Radio List
function renderRadioList() {
  const list = document.getElementById('radio-list');
  list.innerHTML = '';
  CHANNELS.RADIO.forEach(ch => {
    const item = document.createElement('div');
    item.className = 'ch-item';
    item.innerHTML = `<div class="ch-title">${ch.name}</div>`;
    item.onclick = () => playRadio(ch);
    list.appendChild(item);
  });
}

// Function to play radio
function playRadio(channel) {
  destroyPlayers(); // stop video
  const audio = document.getElementById('audio-player');
  audio.src = channel.url;
  audio.play().catch(() => {});
}

// Function to show MyList Section
function showMyList() {
  hideAll();
  document.getElementById('mylist-sec').classList.remove('hidden');
  renderMyListGrid();
}

// Render MyList
function renderMyListGrid() {
  const grid = document.getElementById('mylist-grid');
  grid.innerHTML = '';
  const list = loadMyList();
  if (list.length === 0) {
    grid.innerHTML = `<div class="card"><p>Wala pang laman. Gamitin ang “☆ Save” sa IPTV o Radio para magdagdag.</p></div>`;
  }
  list.forEach(item => {
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div>
        <h4>${item.name}</h4>
        <p style="margin:6px 0 10px;opacity:.8;">Type: ${item.type.toUpperCase()}</p>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="playEntryFromMyList(item)">Play</button>
        <button class="btn" onclick="removeFromMyList(item)">Remove</button>
      </div>
    `;
    grid.appendChild(el);
  });
}

// Function to remove item from MyList
function removeFromMyList(item) {
  const list = loadMyList();
  const index = list.indexOf(item);
  if (index !== -1) {
    list.splice(index, 1);
    saveMyList(list);
    renderMyListGrid();
  }
}

// Function to play item from MyList
function playEntryFromMyList(item) {
  playIPTV(item); // Use the same function to play IPTV
}

// Helper functions to save/load MyList
const MYLIST_KEY = 'threeRS_mylist';
function loadMyList() {
  try { return JSON.parse(localStorage.getItem(MYLIST_KEY) || '[]'); }
  catch (e) { return []; }
}
function saveMyList(arr) {
  localStorage.setItem(MYLIST_KEY, JSON.stringify(arr));
}

// Function to show Chatroom Section
function showChat() {
  hideAll();
  document.getElementById('chat-sec').classList.remove('hidden');
}

// Hide all sections
function hideAll() {
  document.getElementById('home-sec').classList.add('hidden');
  document.getElementById('iptv-sec').classList.add('hidden');
  document.getElementById('radio-sec').classList.add('hidden');
  document.getElementById('mylist-sec').classList.add('hidden');
  document.getElementById('chat-sec').classList.add('hidden');
}

// Initialize and render the list
document.addEventListener('DOMContentLoaded', () => {
  showHome();
  renderIPTVList(); // pre-render IPTV list
});

// Show Home section
function showHome() {
  hideAll();
  document.getElementById('home-sec').classList.remove('hidden');
}

// Show IPTV section
function showIPTV() {
  hideAll();
  document.getElementById('iptv-sec').classList.remove('hidden');
  renderIPTVList(); // Render the IPTV list
  openIPTVDdrawer();
}

// Open the IPTV Drawer
function openIPTVDdrawer() {
  const d = document.getElementById('iptv-drawer');
  d.classList.add('open');
  restartDrawerAutoHide();
}
</script>

</body>
</html>
